{
    "collab_server" : "",
    "contents" : "---\ntitle: \"Redshift test\"\noutput: html_notebook\n---\n\n```{r setup}\nlibrary(dplyr)\nlibrary(RPostgreSQL)  # no TLS support\n\n# dplyr only works with RPostgreSQL at the moment\n# devtools::install_github(\"RcppCore/Rcpp\")\n# devtools::install_github(\"rstats-db/DBI\")\n# devtools::install_github(\"rstats-db/RPostgres\")\n#library(RPostgres)\n```\n\n\n```{r connect_to_redshift}\npg_dsn <- paste0(\n    'dbname=', 'osha', ' ',\n    'sslmode=require'\n)\nhost <-  'tf-redshift-cluster.cx8afkkusjuc.us-east-1.redshift.amazonaws.com'\nport <- 5439\nusername <- 'mcp'\npassword <- Sys.getenv('RedShift_password')\ncon <- dbConnect(RPostgres::Postgres(),\n          dbname = 'osha', \n          host = host, \n          port = port, \n          password = password, \n          user = username)\n\n```\n\n# Load CSVs into Redshift\n\nGet ARN of role to use for reading from S3.\n\n```{r get_s3_reader_arn}\ncmd <- paste0(\"aws sts get-caller-identity --output text --query Account\")\naws_account_id <- system(cmd, intern = TRUE)\n\nrole_name <- c(\"redshift_s3_reader\")\n\ncredentials <- paste0(\"aws_iam_role=arn:aws:iam::\", aws_account_id, \":role/\", role_name)\nmessage(paste0(\"Credentials for S3 Reader are: \", credentials))\n```\n\nCreate a helper function to determine the appropriate SQL structure for a \ndata_frame.\n\n```{r determine_table_structure}\nfind_str <- function(dat) { dat %>% map_df(., \n                                           ~ data_frame(length = max(nchar(.x), na.rm=TRUE), \n                                                        classtype = class(.x)), \n                                           .id = \"column_name\")\n}\ntables <- c(\"optional_info\", \"related_activity\", \"strat_codes\", \"violations\")\n```\n\n## Inspect\n```{sql create_violations_table, connection = con}\nCREATE table violation(\n  activity_nr       integer not null,\n  citation_id       varchar(7),\n  delete_flag       varchar(1),\n  standard          varchar(33),\n  viol_type         varchar(1),\n  issuance_date     date,\n  abate_date        date,\n  abate_complete    varchar(1),\n  current_penalty   decimal,\n  initial_penalty   decimal,\n  contest_date      date,\n  final_order_date  date,\n  nr_instances      integer,\n  nr_exposed        integer,\n  rec               varchar(1),\n  gravity           varchar(2),\n  emphasis          varchar(1),\n  hazcat            varchar(10),\n  fta_insp_nr       varchar(9),\n  fta_issuance_date varchar(10),\n  fta_penalty       varchar(10),\n  fta_contest_date  varchar(10),\n  fta_final_order_date varchar(10),\n  hazsub1           varchar(4),\n  hazsub2           varchar(4),\n  hazsub3           varchar(4),\n  hazsub4           varchar(4),\n  hazsub5           varchar(4),\n  load_dt           datetime,\n  PRIMARY KEY(activity_nr)\n  )\ndistkey(activity_nr)\n```\n```{sql create_strategic_codes_table, connection = con}\nCREATE table strategic_codes(\n  activity_nr       integer not null,\n  prog_type         varchar(1),\n  prog_value        varchar(25),\n  load_dt           datetime,\n  PRIMARY KEY(activity_nr)\n  )\ndistkey(activity_nr)\n```\n\n```{sql create_related_activity_table, connection = con}\nCREATE table related_activity(\n  activity_nr       integer not null,\n  rel_type          varchar(1),\n  rel_act_nr        integer,\n  rel_safety        varchar(1),\n  rel_health        varchar(1),\n  load_dt           datetime,\n  PRIMARY KEY(activity_nr)\n  )\ndistkey(activity_nr)\n```\n\n```{sql create_optional_info_table, connection = con}\nCREATE table optional_info(\n  activity_nr       integer not null,\n  opt_type          varchar(1),\n  opt_id            integer,\n  opt_value         varchar(50),\n  opt_info_id       varchar(1),\n  load_dt           datetime,\n  PRIMARY KEY(activity_nr)\n  )\ndistkey(activity_nr)\n```\n\n```{sql create_inspect_table, connection = con}\nCREATE table inspect(\n  activity_nr       integer not null,\n  reporting_id      integer,\n  state_flag        varchar,\n  estab_name        varchar(100),\n  site_address      varchar(142),\n  site_city         varchar(30),\n  site_state        varchar(18),\n  site_zip          varchar(8),\n  owner_type        varchar(5),\n  owner_code        int,\n  adv_notice        varchar(4),\n  safety_hlth       varchar(8),\n  sic_code          int,\n  naics_code        int,\n  insp_type         varchar(6),\n  insp_score        varchar(6),\n  why_no_insp       varchar(1),\n  union_status      varchar(1),\n  safety_manuf      varchar(1),\n  safety_const      varchar(1),\n  safety_marit      varchar(1),\n  health_manuf      varchar(1),\n  health_const      varchar(1),\n  health_marit      varchar(1),\n  migrant           varchar(1),\n  mail_street       varchar(110),\n  mail_city         varchar(30),\n  mail_state        varchar(2),\n  mail_zip          varchar(5),\n  host_est_key      varchar(18),\n  nr_in_estab       int,\n  open_date         date,\n  case_mod_date     date,\n  close_conf_date   date,\n  close_case_date   date,\n  ld_dt             timestamp,\n  PRIMARY KEY(activity_nr)\n  )\ndistkey(activity_nr)\n```\n\n```{sql, connection = con, output.var = sql_result}\nCOPY INSPECT\n  FROM 's3://users-severski/davidski/osha/osha_inspection.csv.bz2' \n  REGION 'us-west-2'\n  credentials ?credentials\n  CSV IGNOREHEADER AS 1\n  BZIP2\n  MAXERROR 1000;\n```\n\nLoad the `violation` table from CSV.\n\n```{sql, connection = con, output.var = sql_result}\nCOPY VIOLATION\n  FROM 's3://users-severski/davidski/osha/osha_violation.csv.bz2' \n  REGION 'us-west-2'\n  credentials ?credentials\n  CSV IGNOREHEADER AS 1\n  BZIP2\n  MAXERROR 1000;\n```\n\nLoad the `related_activity` table from CSV.\n\n```{sql, connection = con, output.var = sql_result}\nCOPY RELATED_ACTIVITY\n  FROM 's3://users-severski/davidski/osha/osha_related_activity.csv.bz2' \n  REGION 'us-west-2'\n  credentials ?credentials\n  CSV IGNOREHEADER AS 1\n  BZIP2\n  MAXERROR 1000;\n```\n\nLoad the `strategic_codes` table from CSV.\n\n```{sql, connection = con, output.var = sql_result}\nCOPY STRATEGIC_CODES\n  FROM 's3://users-severski/davidski/osha/osha_strategic_codes.csv.bz2' \n  REGION 'us-west-2'\n  credentials ?credentials\n  CSV IGNOREHEADER AS 1\n  BZIP2\n  MAXERROR 1000;\n```\n\nLoad the `optional_info` table from CSV.\n\n```{sql, connection = con, output.var = sql_result}\nCOPY OPTIONAL_INFO\n  FROM 's3://users-severski/davidski/osha/osha_optional_info.csv.bz2' \n  REGION 'us-west-2'\n  credentials ?credentials\n  CSV IGNOREHEADER AS 1\n  BZIP2\n  MAXERROR 1000;\n```\n\nCheck the created table structure\n\n```{sql, connection = con, output.var = sql_result}\nSELECT \"column\", type, encoding, distkey, sortkey\nfrom pg_table_def where tablename = '';\n```\n\n## Check Results\n\nShow our results.\n\n```{r}\nsql_result\n```\nShow the most recent errors\n\n```{sql check_load, connection = con}\nselect starttime, filename, err_reason, line_number,\n  colname, type, col_length, position, raw_field_value,\n  raw_line, err_code\nfrom stl_load_errors\norder by starttime desc;\n```\n\nShow the first 100 records from the RedShift table\n\n```{sql connection = con}\nselect TOP 100 * from inspect;\n```\n\nDoing the same thing, but with R code....\n```{r dbi_query}\ndat <- dbGetQuery(con, \"select TOP 100 * from inspect;\")\ndat\n```\n\n```{sql connection = con, exec=FALSE}\nDROP TABLE violations;\n```\n\n# Connect to data with dplyr\n\n```{r dplyr_setup}\nsrc <- src_postgres(\n  dbname = 'osha',\n  host = host,\n  port = port,\n  password = password,\n  user = username)\n```\n\nGet list of tables. Connect to the inspect table.\n\n```{r dplyr}\nsrc_tbls(src)       # list all tables\ndat <- tbl(src, \"inspect\") # connect to the inspect table\ndat\n```\n\nSample query with dplyr\n\n```{r query_with_dplyr}\nfilter(dat, site_state == \"WA\") %>% \n  mutate(inspect_year = DATE_PART('year', open_date)) %>% \n  group_by(inspect_year, site_city) %>% \n  tally %>% \n  filter(cume_dist(n) > 0.5) %>% \n  #mutate(freq = n /sum(n)) %>%  \n  arrange(desc(inspect_year), desc(n)) %>% collect\n```\n\n\n",
    "created" : 1476996505074.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1656769176",
    "id" : "92002DFA",
    "lastKnownWriteTime" : 1477513686,
    "last_content_update" : 1477513686643,
    "path" : "D:/OSHA/redshift_test.Rmd",
    "project_path" : "redshift_test.Rmd",
    "properties" : {
        "chunk_output_type" : "inline",
        "docOutlineVisible" : "0",
        "last_setup_crc32" : "5738218Cd1ad660d",
        "marks" : "<:26,38\n>:26,39",
        "tempName" : "Untitled1"
    },
    "relative_order" : 2,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}