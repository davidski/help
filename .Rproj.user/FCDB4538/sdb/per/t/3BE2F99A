{
    "collab_server" : "",
    "contents" : "---\ntitle: \"OSHA Exploratory Analysis\"\noutput:\n  html_notebook:\n    highlight: pygments\n    theme: spacelab\n    toc: yes\n  pdf_document:\n    toc: yes\n---\nSetup - Import libraries\n```{r setup, warning=FALSE, message=FALSE}\nlibrary(feather)    # for data storage\nlibrary(stringr)    # for string manipulation\nlibrary(readxl)     # for Excel import\nlibrary(lubridate)  # for date manipulation\nlibrary(scales)     # for pretty printing\nlibrary(tidyverse)  # misc\nlibrary(forcats)    # easier factor manipulation\nlibrary(magrittr)   # for more pipes\n```\n\nThe OSHA data can be found at http://ogesdw.dol.gov/views/data_summary.php.\n\n# Convert Data\n\nWe've downloaded five data files matching with the tables in the data \nchallenge and placed them in the `data` subdirectory. Now we load them in \nfrom CSVs using the `readr` package, which is a faster and more \nintelligent CSV importer than the base version.\n\nEven with `readr`, this is still a slow process. CSVs are useful for \ninterchange, but  aren't a great file format. A better format is \n[Apache Avro](https://avro.apache.org/), which is a standard adopted by both \nthe Rstats and Python communities. We save out our data objects in this format \nusing the `feather` package. We'll use only the Avro-saved objects for future \nsessions, skipping the CSV step. This is __much__ faster.\n\n```{r convert_csvs, eval = FALSE}\nload_data <- function(datatype, load_date) {\n  url_base <- \"http://prd-enforce-xfr-02.dol.gov/data_catalog/OSHA/osha_\"\n  url <- paste0(url_base, datatype, \"_\", load_date, \".csv.zip\")\n  filename <- file.path(\"data\", paste0(\"osha_\", datatype, \".csv.zip\"))\n  if (!file.exists(filename)) {\n    download.file(url, filename)\n  }\n  unzip(filename, exdir = \"data\")\n  read_csv(gsub(\".zip\", \"\", filename))\n}\n\nosha_load_date <- \"20161019\" # date of OSHA files to load in yyyymmdd format\nvariables <- c(\"inspect\", \"strat_codes\", \"optional_info\", \"related_activity\", \"violations\")\nsources <- c(\"inspection\", \"strategic_codes\", \"optional_info\", \"related_activity\", \"violation\")\nwalk2(variables, sources, ~ {assign(.x, load_data(.y, osha_load_date), envir = .GlobalEnv)})\n```\n\nPerform some data type munging on the loaded data set, per the data dictionary and \nexploration.\n\n```{r data_conversion, eval = FALSE}\nrelated_activity %<>% mutate(rel_health = rel_health==\"X\",\n                             rel_safety = rel_safety==\"X\")\ninspect %<>% mutate(naics_code = as.integer(naics_code))\n```\n\n```{r write_feathers, eval = FALSE}\nwrite_feather(inspect, \"./data/osha_inspection.feather\")\nwrite_feather(violations, \"./data/osha_violation.feather\")\nwrite_feather(strat_codes, \"./data/osha_strategic_codes.feather\")\nwrite_feather(optional_info, \"./data/osha_optional_info.feather\")\nwrite_feather(related_activity, \"./data/osha_related_activity.feather\")\n```\n\n```{r load_feathers}\ninspect <- read_feather(\"./data/osha_inspection.feather\")\nstrat_codes <- read_feather(\"./data/osha_strategic_codes.feather\")\noptional_info <- read_feather(\"./data/osha_optional_info.feather\")\nrelated_activity <- read_feather(\"./data/osha_related_activity.feather\")\nviolations <- read_feather(\"./data/osha_violation.feather\")\n```\n\nThe reason for an inspection is defined in the data dictionary. The range of \npossible values is manualy copied from the data dictionary and used to set a\nreference lookup value for this field.\n\n```{r set_inspect_keys}\ninspect_types <- data_frame(\n  code = c(\"A\", \"B\", \"C\", \"D\", \"E\", \"F\", \"G\", \"H\", \"I\", \"J\", \"K\", \"L\", \"M\"), \n  value = c(\"Accident\", \"Complaint\", \"Referral\", \"Monitoring\", \"Variance\", \n            \"FollowUp\", \"Unprog Rel\", \"Planned\", \"Prog Related\", \n            \"Unprog Other\", \"Prog Other\", \"Other-L\",  \"Fat/Cat\")\n)\ninspect_types\n```\n\n## NAICS Data\n\nThe US Census department publishes NAICS codes at http://www.census.gov/eos/www/naics/2017NAICS/2017_NAICS_Structure.xlsx. To \nget this into a referencable object, we pull down the Excel document from the \nCensus site, convert it into a data frame, and perform some minimal clean up \n(conveting strings to numbers, etc.).\n\n```{r naics}\nurl <- \"http://www.census.gov/eos/www/naics/2017NAICS/2017_NAICS_Structure.xlsx\"\nfilename <- \"./data/2017_naics.xlsx\"\nif (!file.exists(filename)) download.file(url, filename, method = \"libcurl\", \n                                          mode = \"wb\")\nnaics <- read_excel(filename, skip = 3, \n                    col_names = c(\"change\", \"code\", \"naics_title\", rep(\"blank\", 3)), \n                    col_types = c(\"text\", \"text\", \"text\", rep(\"blank\", 3)))\nnaics <- naics %>% separate_rows(code, sep = \"-\") %>% \n  filter(is.na(code) == FALSE) %>% \n  mutate(naics_title = str_replace(naics_title, 'T$', \"\"), code = as.numeric(code)) %>% \n  select(-change, code, naics_title)\nnaics\n```\n\n# Notes on the Data\n\n+ Data Dictionary is located at https://enforcedata.dol.gov/views/dd_display.php\n+ More verbose definitions are located at https://osha.gov/oshstats/est1def.html\n\n\n| Table | Object | Purpose |\n|-------|--------|---------|\n|Inspect | inspect | Individual parent inspection of a company |\n|Violation | violations | Specific violation, (n:1) with Inspect based on `activity_nr` |\n|Related Activity | relatated_activities | Links multiple inspection reports in a parent-child relationship in a activity_nr:rel_act_nr format |\n|Optional Info | optional_info | Seems largely empty. Only the `opt_value` field seems to be populated with anything, and its concents seems to have no value. |\n|Strategic Codes | strat_codes | TBD |\n\n## Violation data\n\n| Column | Notes |\n|--------|-------|\n|viol_type| S=Serious.W=Willful.R=Repeat.O=Other (Serious > Willful > Repeat > Other) ref (http://osha.gov/Publications/fedrites.html)|\n|delete_flag| Acutal values of \"X\" don't match with \"D\" in the data dictionary. Should be removed? |\n\n\n# Validate Data\n\nPerform some sanity checks on the data.\n\n## Inspection Data \n\nValid state code include all 50  states plus D.C., VI (Virgin Islands), \nGU (Guam), PR (Puerto Rico).\n\n```{r}\nbad_state_code <- unique(inspect$site_state)[!unique(inspect$site_state) %in% \n                                               c(state.abb, \"DC\", \"VI\", \"GU\", \"PR\")]\nfilter(inspect, site_state %in% bad_state_code) %>% group_by(site_state) %>% tally(sort = TRUE)\n```\n\n## Violations\n\nViolation data has a `delete _flag` which is supposed to be a \"D\" but \nappears to only be an \"X\", when present. \n\n```{r}\ntable(violations$delete_flag)\ngroup_by(violations, delete_flag) %>% tally %>% \n  mutate(pct_of_total = percent(n / sum(n)))\n```\n\nThese delete record represent a small, but non-trivial, amount of the total \ndataset.\n\n## Strategic Codes\n\nThe startegic codes table is defined as allowing the values:\n+ N=NEP (National Emphasis Program)\n+ L=LEP (Local Emphasis Program)\n+ S=Strategic Plan Code\n\n```{r strat_info}\ntable(strat_codes$prog_type)\n```\n\nUnfortunately, there are a number of inspections that have an undefined `P` \ncode. Their meaning is unclear.\n\n```{r explore_ps}\ndat <- filter(strat_codes, prog_type == \"P\") %>% left_join(inspect)\ngroup_by(dat, case_mod_date) %>% tally(sort = TRUE)\n```\nAlmost all of them are modified with a current date. Does `P` somehow indicate a pending inspection?\n```{r}\ndat$close_case_date %>% na.omit() %>% length()\n```\n\nMost of them have a closure date, so the theory of pending seems unfounded.\n\n# Exploratory Analysis\n\nWith the `tibble` package, we get access to the `glimpse` function, as well\nas an enhanced default print.\n\n```{r data_overview}\nglimpse(inspect)\nglimpse(violations)\n```\n\n## Inspect Data\n\n### Reasons for Insepctions\n```{r inspect_reasons}\nleft_join(inspect, inspect_types, by = c(\"insp_type\" = \"code\")) %>% \n            select(value, open_date) %>% \n  group_by(open_date = quarter(open_date, with_year = TRUE), value) %>% \n  tally %>% \n  ggplot(. , aes(x = open_date, y = n, color = fct_reorder2(value, open_date, n))) + geom_line() -> gg\ngg + theme_minimal() + labs(color = \"Inspection Reason\")\n```\n\nHrm. Planned audits have really plummeted. Data not current or are they not \nbeing performed? There's also some big spikes that look to be seasonal.\n\n```{r inspect_seasonality}\ndat <- left_join(inspect, inspect_types, by = c(\"insp_type\" = \"code\")) %>% \n            select(value, open_date) %>% \n  mutate(open_date = format(open_date, \"%b\")) %>% \n  group_by(open_date, value) %>% \n  tally\ndat$open_date <- factor(dat$open_date, levels = month.abb)\ndat <- na.omit(dat)\n\ngg <- ggplot(dat , aes(x = open_date, y = n, group = 1))\ngg <- gg + stat_summary(fun.y = \"sum\", geom = \"line\", \n                        aes(group = value, color = fct_reorder2(value, open_date, n))) \ngg <- gg + scale_y_continuous(label = comma)\ngg + theme_minimal() + labs(color = \"Inspection Reason\", \n                            title = \"Monthly Totals of Inspection Reasons\",\n                            x = \"Month\",\n                            y = element_blank(),\n                            caption = \"OSHA Inspections\")\n```\n\n```{r exploratory_graphs}\ndat <- inspect %>% mutate(industry = as.factor(str_match(naics_code, \"(\\\\d{2})\\\\d+\")[,2])) %>% \n  group_by(industry) %>% tally %>% arrange(desc(n)) %>% filter(is.na(industry) == FALSE)\ngg <- ggplot(dat, aes(x = industry, y = n))\n#gg <- gg + scale_y_log10()\ngg <- gg + geom_bar(stat = \"identity\")\ngg <- gg + theme_minimal()\ngg\n```\n\nIndustry code 23 seems super popular. What is it?\n\n> Code 23 is: `r naics[naics$code == \"23\", ]$naics_title`\n\nAh, construction. What are all the categories in construction?\n\n```{r}\nnaics %>% filter(str_detect(as.character(.$code), \"^23\"))\n```\n\nAnd how many inspections are in each of these construction categories?\n\n```{r}\ninspect %>% filter(str_detect(as.character(.$naics_code), \"^23\")) %>% \n  group_by(naics_code, inspect_year = year(open_date)) %>% summarize(inspections = n()) %>% \n  mutate(pct_by_year = percent(inspections / sum(inspections))) %>% \n  arrange(desc(inspect_year), desc(inspections)) %>% \n  left_join(naics, by = c(\"naics_code\" = \"code\")) %>% \n  select(naics_title, inspect_year, naics_code, everything())\n\n```\n\nSo commerical and roofing are highly inspected industries.\n```{r}\ndat <- inspect %>% mutate(industry = str_match(naics_code, \"(\\\\d{2})\\\\d+\")[,2]) %>% \n  group_by(industry) %>% tally %>% arrange(desc(n)) %>% filter(is.na(industry) == FALSE)\ndat <- left_join(dat, mutate(naics, code = as.character(code)), by = c(\"industry\" = \"code\")) %>% \n  group_by(naics_title) %>% summarize(n = sum(n))\ngg <- ggplot(dat, aes(x = fct_reorder(factor(naics_title), n), y = n))\n#gg <- gg + scale_y_log10()\ngg <- gg + geom_bar(stat = \"identity\")\ngg <- gg + labs(x = \"Industry\", y = \"Number of Inspections\", title = \"Inspections per Industry\")\ngg <- gg + scale_y_continuous(label = comma) + coord_flip()\ngg <- gg + theme_minimal()\ngg\n```\n\n### Advanced Notices\n\nHow have advanced notices of inspections changed over time?\n\n```{r adv_notices}\ndat <- inspect %>% mutate(yr = year(open_date)) %>% \n  group_by(yr, adv_notice) %>% tally() %>% na.omit()\ngg <- ggplot(dat, aes(x = yr, y = n, color = adv_notice)) + geom_line() + \n  theme_minimal() + labs(title = \"Change in Advanced Notice of Inspections over time\", \n                         caption = \"Source: OSHA dataset\",\n                         x = \"Year\",\n                         y = \"Number of Inspections\") +\n  scale_y_continuous(labels = comma)\ngg\n```\n\nInteresting. It looks like advanced notice wasn't tracked, or not given, prior \nto about 1982. There's also a big drop of total inspections at the end. We \nshould look at the distribution of inspections over time.\n\n```{r total_inspections}\ndat <- inspect %>% \n  group_by(open_date = quarter(open_date, with_year = TRUE)) %>% \n  tally\n\n#gg <- ggplot(inspect, aes(x=open_date, y = n, group=quarter(open_date, with_year = TRUE))) + geom_line(na.rm = TRUE)\n#gg <- gg + scale_x_date(date_breaks = \"6 months\")\n\ngg <- ggplot(dat, aes(x = open_date, y = n)) + geom_line(na.rm = TRUE)\ngg <- gg + labs(title = \"Inspections over Time\",\n                subtitle = \"Grouped by Quarter\",\n                caption = \"OSHA Inspection data\",\n                x = \"Date\",\n                y = \"Number of Inspections\")\ngg + theme_minimal() + geom_smooth(method = \"loess\", na.rm = TRUE)\n```\n\nYup. Inspections are down from the late 80s. They've been more or less \nholding steady over the past decade, though there could be a decreasing \ntrend. The big drop of inspections from 77 - 82 is interesting.\n\n## Violations\n\nViolations have an initial penalty (assessed at the time of report authoring) \nand a current penalty (presumably a negotiated settlement). Let's look at these\n\n```{r violation_amounts}\ndat <- violations %>%  select(initial_penalty, current_penalty) %>% \n  na.omit() %>% filter(initial_penalty > 5473 ) %>% \n  mutate(penalty_change = current_penalty - initial_penalty) %>% \n  gather(penalty_type)\n\ndat$penalty_type <- factor(dat$penalty_type, levels=c(\"initial_penalty\", \n                                                      \"current_penalty\", \"penalty_change\"))\ngg <- ggplot(filter(dat, as.character(penalty_type) != \"penalty_change\"), aes(x = value)) + geom_histogram(bins = 50)\n#geom_histogram()\n#+ facet_grid(penalty_type ~ .)\ngg <- gg + scale_x_continuous(trans = \"log1p\", label=dollar) + facet_grid(penalty_type ~ .)\ngg <- gg + labs(title = \"Initial and Current Penalties\", caption = \"OSHA Violations\")\ngg + theme_minimal()\ngg\n\ngg <- ggplot(filter(dat, as.character(penalty_type) == \"penalty_change\"), aes(x = penalty_type, y = value)) \ngg <- gg + geom_violin()\ngg <- gg + scale_y_continuous(label = dollar)\ngg <- gg + labs(title = \"Change in Current vs. Initial Penalties\", caption = \"OSHA Violations\")\ngg + theme_minimal()\n```\n",
    "created" : 1476154638847.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3628508488",
    "id" : "3BE2F99A",
    "lastKnownWriteTime" : 1478059572,
    "last_content_update" : 1478059572431,
    "path" : "D:/OSHA/data_import.Rmd",
    "project_path" : "data_import.Rmd",
    "properties" : {
        "chunk_output_type" : "inline",
        "docOutlineSize" : "199.00535883036022",
        "docOutlineVisible" : "1",
        "last_setup_crc32" : "5738218Cb9f17d74",
        "marks" : "<:76,56\n>:76,56",
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}